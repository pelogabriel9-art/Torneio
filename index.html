<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALFA APOSTAS - Painel de Torneio Simples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .secao { display: none; }
        .secao.visivel { display: block; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-3xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">ALFA APOSTAS - PAINEL TORNEIO</h1>

        <section id="configSection" class="secao mb-6 bg-white p-6 rounded-lg shadow-md"></section>
        <section id="playerNamesSection" class="secao mb-6 bg-white p-6 rounded-lg shadow-md"></section>
        <section id="tournamentSection" class="secao"></section>
        <section id="resultsSection" class="secao"></section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            'use strict';

            // --- Seletores de Se√ß√µes ---
            const sections = {
                config: document.getElementById('configSection'),
                playerNames: document.getElementById('playerNamesSection'),
                tournament: document.getElementById('tournamentSection'),
                results: document.getElementById('resultsSection'),
            };

            // --- Estado da Aplica√ß√£o (agora vive aqui no navegador) ---
            let state = {};

            function resetState() {
                state = {
                    players: [],
                    currentRoundPlayers: [],
                    roundNumber: 1,
                    eliminatedByRound: [],
                    config: {},
                    results: null,
                };
            }

            // --- L√≥gica do Torneio (antes estava no server.js) ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function calculateResults() {
                const { players, config, eliminatedByRound, currentRoundPlayers } = state;
                const { inscricao, orgPercent, prizePercentages } = config;
                const totalArrecadado = players.length * inscricao;
                const orgValue = totalArrecadado * (orgPercent / 100);
                const prizePool = totalArrecadado - orgValue;

                const placements = [];
                placements.push({ rank: 1, name: currentRoundPlayers[0] });
                
                const finalLosers = eliminatedByRound[eliminatedByRound.length - 1] || [];
                if (finalLosers.length > 0) placements.push({ rank: 2, name: finalLosers[0] });
                
                const semiFinalLosers = eliminatedByRound[eliminatedByRound.length - 2] || [];
                if (semiFinalLosers.length > 0) placements.push({ rank: 3, name: semiFinalLosers[0] });
                if (semiFinalLosers.length > 1) placements.push({ rank: 4, name: semiFinalLosers[1] });
                
                const finalPlacements = placements.map((p, i) => {
                    const prizeValue = prizePool * ((prizePercentages[i] || 0) / 100);
                    return { ...p, prize: prizeValue };
                });

                state.results = {
                    summary: { totalArrecadado, orgValue, prizePool },
                    placements: finalPlacements,
                };
            }

            // --- Fun√ß√µes de Renderiza√ß√£o (desenham a tela) ---

            function renderConfigView() {
                sections.config.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Configura√ß√µes do Torneio</h2>
                    <form id="configForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="numPlayers" class="block text-lg mb-2">Jogadores (m√≠n. 2):</label><input type="number" id="numPlayers" min="2" value="8" class="border p-2 w-full rounded-md" required></div>
                        <div><label for="inscricao" class="block text-lg mb-2">Inscri√ß√£o (R$):</label><input type="number" id="inscricao" min="0" step="0.01" value="10" class="border p-2 w-full rounded-md" required></div>
                        <div><label for="orgPercent" class="block text-lg mb-2">Taxa da Org. (%):</label><input type="number" id="orgPercent" min="0" max="100" value="20" class="border p-2 w-full rounded-md" required></div>
                        <div class="md:col-span-2">
                            <h3 class="text-lg font-semibold mb-2">Premia√ß√£o (%):</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div><label class="block text-sm">1¬∫ Lugar:</label><input type="number" value="50" class="prize-percent border p-2 w-full"></div>
                                <div><label class="block text-sm">2¬∫ Lugar:</label><input type="number" value="30" class="prize-percent border p-2 w-full"></div>
                                <div><label class="block text-sm">3¬∫ Lugar:</label><input type="number" value="15" class="prize-percent border p-2 w-full"></div>
                                <div><label class="block text-sm">4¬∫ Lugar:</label><input type="number" value="5" class="prize-percent border p-2 w-full"></div>
                            </div>
                        </div>
                        <button type="submit" class="md:col-span-2 mt-4 bg-blue-600 text-white p-3 rounded-md hover:bg-blue-700 font-bold w-full">Definir Jogadores</button>
                    </form>
                `;
                document.getElementById('configForm').addEventListener('submit', handleConfigSubmit);
                showSection(sections.config);
            }

            function renderPlayerNamesView() {
                let inputsHTML = '';
                for (let i = 0; i < state.config.numPlayers; i++) {
                    inputsHTML += `<input type="text" class="border p-2 w-full rounded-md" placeholder="Nome do Jogador ${i + 1}" required>`;
                }
                sections.playerNames.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Nomes dos Jogadores</h2>
                    <form id="playerNamesForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputsHTML}</div>
                        <button type="submit" class="mt-6 bg-green-600 text-white p-3 rounded-md hover:bg-green-700 font-bold w-full">Iniciar Torneio</button>
                    </form>
                `;
                document.getElementById('playerNamesForm').addEventListener('submit', handlePlayerNamesSubmit);
                showSection(sections.playerNames);
            }
            
            function renderTournamentView() {
                const { roundNumber, currentRoundPlayers } = state;
                let matchesHTML = '';
                const matches = [];
                for (let i = 0; i < currentRoundPlayers.length; i += 2) {
                    if (i + 1 < currentRoundPlayers.length) {
                        const p1 = currentRoundPlayers[i];
                        const p2 = currentRoundPlayers[i + 1];
                        matches.push([p1, p2]);
                        matchesHTML += `
                            <div class="bg-white p-4 rounded-lg shadow-sm border">
                                <p class="font-semibold text-center mb-2">${p1} vs ${p2}</p>
                                <select class="border p-2 rounded-md mt-2 w-full bg-gray-50" required><option value="">Selecione o vencedor</option><option value="${p1}">${p1}</option><option value="${p2}">${p2}</option></select>
                            </div>`;
                    }
                }
                state.matches = matches; // Armazena as partidas atuais no estado

                if (currentRoundPlayers.length % 2 !== 0) {
                    const byePlayer = currentRoundPlayers[currentRoundPlayers.length - 1];
                    matchesHTML += `<div class="bg-blue-50 p-4 rounded-lg shadow-sm border-l-4 border-blue-500"><p class="font-semibold text-center">${byePlayer} avan√ßou (bye).</p></div>`;
                }
                
                sections.tournament.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4 text-center">Rodada ${roundNumber} - ${currentRoundPlayers.length} jogadores</h2>
                    <form id="matchesForm" class="space-y-4">${matchesHTML}</form>
                    <button id="nextRoundBtn" class="mt-6 bg-purple-600 text-white p-3 rounded-md hover:bg-purple-700 font-bold w-full">Avan√ßar Rodada</button>
                `;
                document.getElementById('nextRoundBtn').addEventListener('click', handleNextRound);
                showSection(sections.tournament);
            }

            function renderResultsView() {
                const { summary, placements } = state.results;
                const formatCurrency = (val) => (val || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const placementsHTML = placements.map(({ rank, name, prize }) => `
                    <tr><td class="border p-2 font-bold">${rank}¬∫ Lugar</td><td class="border p-2">${name}</td><td class="border p-2">${formatCurrency(prize)}</td></tr>`).join('');

                sections.results.innerHTML = `
                    <div class="text-center bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-bold text-green-600 mb-4">üèÜ Resultados Finais üèÜ</h2>
                        <table class="w-full border-collapse mb-6"><thead class="bg-gray-200"><tr><th class="border p-2">Coloca√ß√£o</th><th class="border p-2">Jogador</th><th class="border p-2">Pr√™mio (R$)</th></tr></thead><tbody>${placementsHTML}</tbody></table>
                        <div class="space-y-2 text-lg bg-gray-50 p-4 rounded-md">
                            <p class="font-semibold">Total Arrecadado: ${formatCurrency(summary.totalArrecadado)}</p>
                            <p class="font-medium text-blue-600">Taxa da Organiza√ß√£o: ${formatCurrency(summary.orgValue)}</p>
                            <p class="font-bold text-green-700">Premia√ß√£o Total: ${formatCurrency(summary.prizePool)}</p>
                        </div>
                        <button id="resetBtn" class="mt-6 bg-red-600 text-white p-3 rounded-md hover:bg-red-700 font-bold">Novo Torneio</button>
                    </div>
                `;
                document.getElementById('resetBtn').addEventListener('click', handleReset);
                showSection(sections.results);
            }

            // --- Fun√ß√µes de "Handle" (controlam os eventos) ---
            
            function handleConfigSubmit(event) {
                event.preventDefault();
                state.config = {
                    numPlayers: parseInt(document.getElementById('numPlayers').value),
                    inscricao: parseFloat(document.getElementById('inscricao').value),
                    orgPercent: parseFloat(document.getElementById('orgPercent').value),
                    prizePercentages: Array.from(document.querySelectorAll('.prize-percent')).map(el => parseFloat(el.value) || 0),
                };
                renderPlayerNamesView();
            }

            function handlePlayerNamesSubmit(event) {
                event.preventDefault();
                state.players = Array.from(event.target.querySelectorAll('input')).map((input, i) => input.value.trim() || `Jogador ${i + 1}`);
                state.currentRoundPlayers = shuffleArray([...state.players]);
                renderTournamentView();
            }

            function handleNextRound() {
                const winners = Array.from(document.querySelectorAll('#matchesForm select')).map(select => select.value);
                if (winners.some(w => w === '')) { return alert('Por favor, selecione todos os vencedores.'); }
                
                const losers = state.matches.flat().filter(player => !winners.includes(player));
                state.eliminatedByRound.push(losers);

                let nextRoundPlayers = [...winners];
                if (state.currentRoundPlayers.length % 2 !== 0) {
                    nextRoundPlayers.push(state.currentRoundPlayers[state.currentRoundPlayers.length - 1]);
                }
                state.currentRoundPlayers = nextRoundPlayers;
                
                if (nextRoundPlayers.length <= 1) {
                    calculateResults();
                    renderResultsView();
                } else {
                    state.roundNumber++;
                    renderTournamentView();
                }
            }
            
            function handleReset() {
                resetState();
                renderConfigView();
            }

            function showSection(sectionToShow) {
                Object.values(sections).forEach(section => section.classList.remove('visivel'));
                sectionToShow.classList.add('visivel');
            }

            // --- Inicializa√ß√£o ---
            function init() {
                resetState();
                renderConfigView();
            }

            init();
        });
    </script>
</body>
</html>
